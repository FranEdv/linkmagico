# üöÄ Link M√°gico - Guia Completo de Configura√ß√£o

## üìã √çndice

1. [Vis√£o Geral das Melhorias](#vis√£o-geral-das-melhorias)
2. [Pr√©-requisitos](#pr√©-requisitos)
3. [Instala√ß√£o](#instala√ß√£o)
4. [Configura√ß√£o B√°sica](#configura√ß√£o-b√°sica)
5. [Configura√ß√£o Avan√ßada](#configura√ß√£o-avan√ßada)
6. [Deploy no Render](#deploy-no-render)
7. [Testando as Funcionalidades](#testando-as-funcionalidades)
8. [Troubleshooting](#troubleshooting)

---

## üéØ Vis√£o Geral das Melhorias

### ‚úÖ O que foi implementado:

1. **Sistema de Banco de Dados**
   - PostgreSQL para produ√ß√£o
   - SQLite para desenvolvimento
   - Persist√™ncia de chatbots, conversas e analytics

2. **Sistema de Cache Inteligente**
   - Redis para produ√ß√£o
   - In-Memory para desenvolvimento
   - Cache de extra√ß√µes (24h) e respostas (1h)
   - Rate limiting por API key

3. **Dashboard de Analytics Profissional**
   - M√©tricas detalhadas de uso
   - Exporta√ß√£o para CSV
   - Rastreamento de custos
   - An√°lise de satisfa√ß√£o

4. **Sistema de Webhooks**
   - Integra√ß√£o com sistemas externos
   - Eventos: conversa iniciada/finalizada, lead capturado, etc.
   - Retry autom√°tico
   - Assinatura HMAC para seguran√ßa

5. **Sistema de Billing e Pagamentos**
   - 4 planos: Free, Starter, Professional, Enterprise
   - Integra√ß√£o com Stripe
   - Preparado para PayPal e PagSeguro
   - Controle de limites e uso

6. **Gest√£o de Conhecimento Avan√ßada**
   - M√∫ltiplas fontes: URLs, FAQs, Documentos
   - Upload de PDFs (preparado)
   - Busca inteligente
   - Base de conhecimento incremental

7. **Otimiza√ß√£o de Custos LLM**
   - Cache de respostas similares
   - An√°lise de complexidade de perguntas
   - Fallback inteligente entre provedores
   - Monitoramento de tokens e custos

8. **Melhorias no Sistema de Extra√ß√£o**
   - Cache de extra√ß√µes
   - Retry em caso de falha
   - Valida√ß√£o de qualidade

### ‚úÖ O que foi mantido intacto:

- ‚úÖ GROQ API como principal
- ‚úÖ OpenAI API como fallback 1
- ‚úÖ OpenRouter API como fallback 2
- ‚úÖ L√≥gica nativa existente
- ‚úÖ Todas as rotas e fluxos atuais
- ‚úÖ Sistema de leads
- ‚úÖ An√°lise de jornada do cliente
- ‚úÖ Extra√ß√£o de contatos
- ‚úÖ Widget e embed

---

## üì¶ Pr√©-requisitos

### Desenvolvimento Local:

```bash
- Node.js >= 18.x
- npm ou yarn
- Git
```

### Produ√ß√£o (Render):

```bash
- Conta no Render (gratuita)
- Conta no Stripe (opcional, para pagamentos)
- Conta no Redis Cloud (opcional, para cache)
- Conta no ElephantSQL ou similar (opcional, para PostgreSQL)
```

---

## üîß Instala√ß√£o

### 1. Clonar/Baixar o Projeto

Se voc√™ est√° usando o c√≥digo melhorado:

```bash
cd linkmagico-melhorado
```

### 2. Instalar Depend√™ncias

```bash
npm install
```

As novas depend√™ncias j√° est√£o no `package.json`:
- `pg` - PostgreSQL client
- `better-sqlite3` - SQLite client
- `stripe` - Pagamentos
- `redis` - Cache (j√° estava instalado)

### 3. Configurar Vari√°veis de Ambiente

Copie o arquivo de exemplo:

```bash
cp .env.example .env
```

Edite o arquivo `.env` com suas configura√ß√µes:

```env
# ===== ESSENCIAL =====
PORT=3000
NODE_ENV=development

# APIs de LLM (mantenha as que voc√™ j√° tem)
GROQ_API_KEY=sua_chave_groq
OPENAI_API_KEY=sua_chave_openai
OPENROUTER_API_KEY=sua_chave_openrouter

# Seguran√ßa
SESSION_SECRET=gere_uma_chave_aleatoria_aqui_min_32_caracteres

# ===== DESENVOLVIMENTO (usar SQLite e cache in-memory) =====
USE_POSTGRES=false
USE_REDIS=false

# ===== PRODU√á√ÉO (configurar depois) =====
# DATABASE_URL=postgresql://...
# REDIS_URL=redis://...
# STRIPE_SECRET_KEY=sk_live_...
```

---

## üöÄ Configura√ß√£o B√°sica (Desenvolvimento)

### Passo 1: Usar o Server Melhorado

Renomeie o server original e use o melhorado:

```bash
# Backup do original (j√° foi feito)
# cp server.js server.js.backup

# Usar o server melhorado
cp server-melhorado.js server.js
```

### Passo 2: Iniciar o Servidor

```bash
npm start
```

Ou para desenvolvimento com auto-reload:

```bash
npm run dev
```

### Passo 3: Verificar Status

Acesse no navegador:

```
http://localhost:3000/api/system/status
```

Voc√™ deve ver algo como:

```json
{
  "success": true,
  "status": {
    "server": "online",
    "database": {
      "type": "SQLite",
      "connected": true
    },
    "cache": {
      "type": "In-Memory",
      "connected": true
    },
    "webhooks": {
      "totalWebhooks": 0,
      "activeWebhooks": 0
    },
    "features": {
      "billing": false,
      "webhooks": true,
      "analytics": true,
      "llmOptimization": true,
      "knowledgeBase": true
    }
  }
}
```

---

## ‚öôÔ∏è Configura√ß√£o Avan√ßada

### 1. Configurar PostgreSQL (Produ√ß√£o)

#### Op√ß√£o A: ElephantSQL (Gratuito)

1. Acesse https://www.elephantsql.com/
2. Crie uma conta gratuita
3. Crie uma nova inst√¢ncia (plano Tiny Turtle - gratuito)
4. Copie a URL de conex√£o
5. Adicione no `.env`:

```env
USE_POSTGRES=true
DATABASE_URL=postgres://usuario:senha@host/database
```

#### Op√ß√£o B: Render PostgreSQL

1. No dashboard do Render, crie um novo PostgreSQL
2. Copie a "Internal Database URL"
3. Adicione no `.env`

### 2. Configurar Redis (Produ√ß√£o)

#### Op√ß√£o A: Redis Cloud (Gratuito)

1. Acesse https://redis.com/try-free/
2. Crie uma conta gratuita
3. Crie um novo database (30MB gratuito)
4. Copie a URL de conex√£o
5. Adicione no `.env`:

```env
USE_REDIS=true
REDIS_URL=redis://default:senha@host:port
```

#### Op√ß√£o B: Upstash (Gratuito)

1. Acesse https://upstash.com/
2. Crie um database Redis
3. Copie a URL de conex√£o

### 3. Configurar Stripe (Pagamentos)

1. Acesse https://stripe.com/
2. Crie uma conta
3. V√° em Developers > API Keys
4. Copie as chaves:

```env
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
```

5. Configure o webhook:
   - URL: `https://seu-dominio.com/api/webhooks/stripe`
   - Eventos: `checkout.session.completed`, `customer.subscription.*`, `invoice.*`
   - Copie o Signing Secret:

```env
STRIPE_WEBHOOK_SECRET=whsec_...
```

### 4. Configurar Rate Limiting

```env
RATE_LIMIT_REQUESTS=100  # Requisi√ß√µes por janela
RATE_LIMIT_WINDOW=60     # Janela em segundos
```

### 5. Configurar Analytics

```env
ANALYTICS_RETENTION_DAYS=90      # Manter dados por 90 dias
ANALYTICS_FLUSH_INTERVAL=60000   # Salvar a cada 60 segundos
```

---

## üåê Deploy no Render

### Passo 1: Preparar o Reposit√≥rio

1. Certifique-se de que todos os arquivos est√£o commitados:

```bash
git add .
git commit -m "Implementa√ß√£o de melhorias - Link M√°gico"
git push origin main
```

### Passo 2: Criar Web Service no Render

1. Acesse https://dashboard.render.com/
2. Clique em "New +" > "Web Service"
3. Conecte seu reposit√≥rio GitHub
4. Configure:
   - **Name**: linkmagico-melhorado
   - **Environment**: Node
   - **Build Command**: `npm install`
   - **Start Command**: `npm start`
   - **Plan**: Free

### Passo 3: Configurar Vari√°veis de Ambiente

No Render, v√° em "Environment" e adicione:

```
GROQ_API_KEY=sua_chave
OPENAI_API_KEY=sua_chave
OPENROUTER_API_KEY=sua_chave
SESSION_SECRET=chave_aleatoria_32_chars
NODE_ENV=production
USE_POSTGRES=false
USE_REDIS=false
```

### Passo 4: Deploy

1. Clique em "Create Web Service"
2. Aguarde o deploy (5-10 minutos)
3. Acesse a URL fornecida pelo Render

### Passo 5: Configurar PostgreSQL (Opcional)

1. No Render, crie um PostgreSQL
2. Copie a "Internal Database URL"
3. Adicione nas vari√°veis de ambiente:

```
USE_POSTGRES=true
DATABASE_URL=postgresql://...
```

4. Fa√ßa um novo deploy

### Passo 6: Configurar Redis (Opcional)

1. Crie um Redis no Redis Cloud ou Upstash
2. Adicione nas vari√°veis de ambiente:

```
USE_REDIS=true
REDIS_URL=redis://...
```

3. Fa√ßa um novo deploy

---

## üß™ Testando as Funcionalidades

### 1. Testar Analytics

```bash
# Obter analytics de um chatbot
curl http://localhost:3000/api/analytics/CHATBOT_ID?days=7

# Exportar para CSV
curl http://localhost:3000/api/analytics/CHATBOT_ID/export?startDate=2024-01-01&endDate=2024-01-31
```

### 2. Testar Webhooks

```bash
# Registrar webhook
curl -X POST http://localhost:3000/api/webhooks/CHATBOT_ID \
  -H "Content-Type: application/json" \
  -d '{
    "eventType": "lead_captured",
    "url": "https://webhook.site/seu-id"
  }'

# Listar webhooks
curl http://localhost:3000/api/webhooks/CHATBOT_ID

# Testar webhook
curl -X POST http://localhost:3000/api/webhooks/CHATBOT_ID/WEBHOOK_ID/test
```

### 3. Testar Billing

```bash
# Listar planos
curl http://localhost:3000/api/plans

# Obter assinatura
curl http://localhost:3000/api/subscription/USER_ID

# Fazer upgrade
curl -X POST http://localhost:3000/api/subscription/USER_ID/upgrade \
  -H "Content-Type: application/json" \
  -d '{"planId": "professional"}'
```

### 4. Testar Knowledge Base

```bash
# Adicionar FAQ
curl -X POST http://localhost:3000/api/knowledge/CHATBOT_ID/faq \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Qual o hor√°rio de funcionamento?",
    "answer": "Funcionamos de segunda a sexta, das 9h √†s 18h",
    "category": "atendimento"
  }'

# Adicionar m√∫ltiplas FAQs
curl -X POST http://localhost:3000/api/knowledge/CHATBOT_ID/faqs/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "faqs": [
      {
        "question": "Aceitam cart√£o?",
        "answer": "Sim, aceitamos todas as bandeiras",
        "category": "pagamento"
      },
      {
        "question": "Fazem entrega?",
        "answer": "Sim, entregamos em toda a cidade",
        "category": "entrega"
      }
    ]
  }'

# Obter estat√≠sticas
curl http://localhost:3000/api/knowledge/CHATBOT_ID/stats
```

### 5. Testar Otimiza√ß√£o LLM

```bash
# Obter estat√≠sticas de uso
curl http://localhost:3000/api/llm/stats/CHATBOT_ID?days=30
```

### 6. Testar Cache

```bash
# Obter estat√≠sticas do cache
curl http://localhost:3000/api/cache/stats

# Limpar cache
curl -X POST http://localhost:3000/api/cache/clear \
  -H "Content-Type: application/json" \
  -d '{"pattern": "extraction:*"}'
```

---

## üîç Troubleshooting

### Problema: Erro ao conectar no PostgreSQL

**Solu√ß√£o:**
1. Verifique se a URL est√° correta
2. Teste a conex√£o:

```bash
psql "postgresql://usuario:senha@host/database"
```

3. Se n√£o funcionar, use SQLite temporariamente:

```env
USE_POSTGRES=false
```

### Problema: Erro ao conectar no Redis

**Solu√ß√£o:**
1. Verifique se a URL est√° correta
2. Teste a conex√£o:

```bash
redis-cli -u redis://default:senha@host:port ping
```

3. Se n√£o funcionar, use cache in-memory:

```env
USE_REDIS=false
```

### Problema: Stripe n√£o funciona

**Solu√ß√£o:**
1. Verifique se as chaves est√£o corretas
2. Use o modo de teste primeiro (`sk_test_...`)
3. Configure o webhook corretamente
4. Se n√£o precisar de pagamentos agora, deixe desabilitado

### Problema: Server n√£o inicia

**Solu√ß√£o:**
1. Verifique os logs:

```bash
npm start
```

2. Verifique se todas as depend√™ncias est√£o instaladas:

```bash
npm install
```

3. Verifique se o `.env` est√° configurado corretamente

4. Teste a sintaxe:

```bash
node -c server.js
```

### Problema: Rotas antigas n√£o funcionam

**Solu√ß√£o:**
Todas as rotas antigas foram mantidas. Se alguma n√£o funcionar:

1. Verifique se o `server-melhorado.js` foi copiado corretamente
2. Compare com o `server.js.original`
3. Se necess√°rio, reverta:

```bash
cp server.js.original server.js
```

---

## üìä Estrutura de Arquivos

```
linkmagico-melhorado/
‚îú‚îÄ‚îÄ server.js                    # Server principal (melhorado)
‚îú‚îÄ‚îÄ server.js.original           # Backup do original
‚îú‚îÄ‚îÄ server-melhorado.js          # Vers√£o melhorada (antes de copiar)
‚îú‚îÄ‚îÄ database.js                  # Sistema de banco de dados
‚îú‚îÄ‚îÄ cache.js                     # Sistema de cache
‚îú‚îÄ‚îÄ webhooks.js                  # Sistema de webhooks
‚îú‚îÄ‚îÄ billing.js                   # Sistema de billing
‚îú‚îÄ‚îÄ analytics.js                 # Sistema de analytics
‚îú‚îÄ‚îÄ llm-optimizer.js             # Otimiza√ß√£o de custos LLM
‚îú‚îÄ‚îÄ knowledge-base.js            # Gest√£o de conhecimento
‚îú‚îÄ‚îÄ routes.js                    # Novas rotas de API
‚îú‚îÄ‚îÄ init.js                      # Script de inicializa√ß√£o
‚îú‚îÄ‚îÄ .env                         # Vari√°veis de ambiente
‚îú‚îÄ‚îÄ .env.example                 # Exemplo de configura√ß√£o
‚îú‚îÄ‚îÄ package.json                 # Depend√™ncias
‚îú‚îÄ‚îÄ GUIA_CONFIGURACAO.md         # Este arquivo
‚îî‚îÄ‚îÄ data/                        # Dados persistentes
    ‚îú‚îÄ‚îÄ linkmagico.db            # SQLite database (dev)
    ‚îú‚îÄ‚îÄ analytics/               # Arquivos de analytics
    ‚îî‚îÄ‚îÄ knowledge/               # Bases de conhecimento
```

---

## üéØ Pr√≥ximos Passos

### Curto Prazo:

1. ‚úÖ Testar todas as funcionalidades localmente
2. ‚úÖ Fazer deploy no Render
3. ‚úÖ Configurar PostgreSQL e Redis
4. ‚úÖ Configurar Stripe (se for usar pagamentos)

### M√©dio Prazo:

1. üì± Desenvolver app Shopify
2. üîå Plugin WooCommerce
3. üìß Sistema de email
4. üìä Dashboard visual (frontend)

### Longo Prazo:

1. ü§ñ Integra√ß√£o com mais LLMs
2. üåç Suporte multi-idioma
3. üì± App mobile
4. üé® White-label completo

---

## üìû Suporte

Se tiver d√∫vidas ou problemas:

1. Verifique este guia primeiro
2. Consulte os logs do servidor
3. Teste as rotas de API
4. Verifique as vari√°veis de ambiente

---

## üéâ Conclus√£o

Parab√©ns! Voc√™ agora tem uma vers√£o profissional e escal√°vel do Link M√°gico com:

- ‚úÖ Banco de dados persistente
- ‚úÖ Cache inteligente
- ‚úÖ Analytics profissional
- ‚úÖ Sistema de webhooks
- ‚úÖ Billing e pagamentos
- ‚úÖ Gest√£o de conhecimento
- ‚úÖ Otimiza√ß√£o de custos
- ‚úÖ Todas as funcionalidades originais mantidas

**Boa sorte com seu projeto!** üöÄ
